name: "VProfile Actions"
on: workflow_dispatch
env:
    AWS_REGION: "us-east-1"
    ECR_REPOSITORY: "vprofileactionsapp"
    EKS_CLUSTER: "vprofile-eks"
    SONAR_PROJECT_KEY: "vprofile-actions33_vproapp24"
    SONAR_ORGANIZATION: "vprofile-actions33"
    SONAR_URL: "https://sonarcloud.io"

jobs:
    Testing:
        runs-on: ubuntu-latest
        steps:
        - name: Code Checkout
          uses: actions/checkout@v3
        
        - name: Maven Test
          run: mvn test

        - name: checkstyle
          run: mvn checkstyle:checkstyle

        - name: set up Java 
          uses: actions/setup-java@v3
          with:
              distribution: 'temurin'
              java-version: '11'

        - name: setup sonar scanner
          uses: warchant/setup-sonar-scanner@v7
          
        - name: sonar scan
          run: sonar-scanner \
              -Dsonar.projectKey=$SONAR_PROJECT_KEY \
              -Dsonar.organization=$SONAR_ORGANIZATION \
              -Dsonar.host.url=$SONAR_URL \
              -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
              -Dsonar.sources=src/ \
              -Dsonar.junit.reportPaths=target/surefire-reports \
              -Dsonar.jacoco.reportPaths=target/jacoco.exec \
              -Dsonar.java.checkstyle.reportPaths=target/checkstyle-result.xml \
              -Dsonar.java.binaries=target/test-classes/com/visualpathit/account

        - name: Check Sonar Quality Gate
          uses: sonarsource/sonarcloud-github-action@master
          env:
              SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
              SONAR_HOST_URL: ${{ env.SONAR_URL }}